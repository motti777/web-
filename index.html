<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LineCall Elite Pro</title>
    <style>
        :root { --line-green: #06c755; --line-blue: #8cabd0; --my-msg: #85e249; --bg: #fff; --gray: #f0f0f0; --danger: #ff3b30; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, sans-serif; }
        body { background: #000; margin: 0; display: flex; justify-content: center; height: 100vh; overflow: hidden; }
        
        .app-container { width: 100%; max-width: 450px; height: 100dvh; background: var(--bg); position: relative; display: flex; flex-direction: column; }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header { background: #fff; padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 15px; }
        .my-avatar-btn { font-size: 35px; width: 60px; height: 60px; background: var(--gray); border-radius: 22px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid var(--line-green); transition: 0.2s; }
        .my-avatar-btn:active { transform: scale(0.9); }
        .my-info { flex: 1; }
        .my-num-display { background: var(--line-green); color: #fff; padding: 2px 10px; border-radius: 10px; font-size: 18px; font-weight: bold; display: inline-block; margin-top: 4px; }

        /* é€£çµ¡å…ˆãƒªã‚¹ãƒˆ */
        .main-content { flex: 1; overflow-y: auto; background: #fff; }
        .list-item { display: flex; align-items: center; padding: 15px 20px; border-bottom: 1px solid #f5f5f5; cursor: pointer; }
        .list-item:active { background: #f5f5f5; }
        .user-avatar { font-size: 28px; width: 50px; height: 50px; background: #eee; border-radius: 18px; display: flex; align-items: center; justify-content: center; margin-right: 15px; }

        /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #edit-modal { position: absolute; inset: 0; background: rgba(0,0,0,0.8); z-index: 4000; display: none; align-items: center; justify-content: center; padding: 30px; }
        .modal-card { background: #fff; width: 100%; border-radius: 25px; padding: 25px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .edit-input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: 1px solid #ddd; font-size: 18px; text-align: center; outline: none; }

        /* ãƒãƒ£ãƒƒãƒˆç”»é¢ */
        #chat-view { position: absolute; inset: 0; background: var(--line-blue); z-index: 2000; display: none; flex-direction: column; }
        .chat-header { background: rgba(255,255,255,0.9); padding: 10px 15px; display: flex; align-items: center; gap: 10px; backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0,0,0,0.1); }
        .chat-main { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        
        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¹ãå‡ºã— */
        .msg { max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 15px; position: relative; cursor: pointer; word-wrap: break-word; }
        .msg.left { align-self: flex-start; background: #fff; border-top-left-radius: 2px; }
        .msg.right { align-self: flex-end; background: var(--my-msg); border-top-right-radius: 2px; }
        .msg.deleted { background: rgba(0,0,0,0.08); color: rgba(0,0,0,0.4); font-style: italic; font-size: 12px; cursor: default; }

        .chat-input-area { background: #fff; padding: 12px; display: flex; gap: 10px; align-items: center; }
        .msg-input-field { flex: 1; border: none; background: #f0f0f0; padding: 10px 15px; border-radius: 20px; outline: none; font-size: 16px; }

        /* é€šè©±ç”»é¢ */
        #call-ui { position: absolute; inset: 0; background: #000; z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; color: #fff; }
        #remote-v { width: 100%; height: 100%; object-fit: cover; position: absolute; }
        #local-v { position: absolute; top: 20px; right: 20px; width: 100px; height: 150px; border-radius: 10px; border: 1px solid #555; display: none; object-fit: cover; z-index: 5002; }
        .call-controls { position: relative; z-index: 5001; text-align: center; width: 100%; }
        .hangup { background: var(--danger); width: 75px; height: 75px; border-radius: 50%; border: none; color: #fff; font-size: 30px; margin-top: 100px; cursor: pointer; transition: 0.2s; }
        .hangup:active { transform: scale(0.9); }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="header" id="main-header">
            <div class="my-avatar-btn" id="my-avatar" onclick="openEdit()">ğŸ‘¤</div>
            <div class="my-info">
                <div id="my-name-display" style="font-weight: bold; font-size: 18px;">åå‰æœªè¨­å®š</div>
                <div class="my-num-display" id="my-num">------</div>
            </div>
            <button onclick="addFriendByNum()" style="background:none; border:none; font-size:25px; cursor:pointer;">â•</button>
        </div>

        <div class="main-content" id="contact-list"></div>

        <div id="edit-modal">
            <div class="modal-card">
                <h3 style="margin-top:0;">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å¤‰æ›´</h3>
                <div class="my-avatar-btn" id="edit-emoji" onclick="cycleEmoji()" style="margin: 0 auto 20px;">ğŸ‘¤</div>
                <input type="text" id="edit-name" class="edit-input" placeholder="åå‰ã‚’å…¥åŠ›">
                <button onclick="saveProfile()" style="width:100%; padding:15px; background:var(--line-green); color:#fff; border:none; border-radius:10px; font-weight:bold; cursor:pointer; margin-top:10px;">ä¿å­˜ã—ã¦æ›´æ–°</button>
            </div>
        </div>

        <div id="chat-view">
            <div class="chat-header">
                <button onclick="closeChat()" style="background:none; border:none; font-size:20px; cursor:pointer;">â—€</button>
                <div style="flex:1; font-weight:bold; text-align:center;" id="chat-title">ç›¸æ‰‹ã®åå‰</div>
                <div style="display:flex; gap:20px;">
                    <span onclick="call('audio')" style="cursor:pointer; font-size:22px;">ğŸ“</span>
                    <span onclick="call('video')" style="cursor:pointer; font-size:22px;">ğŸ¥</span>
                </div>
            </div>
            <div class="chat-main" id="chat-msgs"></div>
            <div class="chat-input-area">
                <input type="text" id="msg-input" class="msg-input-field" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...">
                <button onclick="send()" style="border:none; background:none; color:var(--line-green); font-weight:bold; font-size:16px; cursor:pointer;">é€ä¿¡</button>
            </div>
        </div>

        <div id="call-ui">
            <video id="remote-v" autoplay playsinline></video>
            <video id="local-v" autoplay playsinline muted></video>
            <div class="call-controls">
                <div id="call-user-emoji" style="font-size:80px; margin-bottom:20px;">ğŸ‘¤</div>
                <h2 id="call-user-name" style="margin:0; font-size:24px;">ç›¸æ‰‹ã®åå‰</h2>
                <div style="margin-top:10px; color:var(--line-green);">é€šè©±ä¸­...</div>
                <button onclick="location.reload()" class="hangup">âœ•</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@skyway-sdk/room/dist/skyway_room.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, addDoc, updateDoc, query, where, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebaseè¨­å®š
        const firebaseConfig = { 
            apiKey: "AIzaSyAqypcabvYQDHzxNnjJmbDMs-vbYXLPhI8", 
            authDomain: "webt-f0724.firebaseapp.com", 
            projectId: "webt-f0724", 
            storageBucket: "webt-f0724.firebasestorage.app", 
            appId: "1:835151283262:web:a7efe3cc384fa1a61dfd6f" 
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const SKYWAY_ID = '697b5b5d-3f7c-4430-bd32-deb0ca2de936';

        let my = { uid: "", num: "", name: "åå‰æœªè¨­å®š", emoji: "ğŸ‘¤" };
        let target = null;
        const emojis = ["ğŸ‘¤","ğŸ±","ğŸ¶","ğŸ¦Š","ğŸ»","ğŸ¼","ğŸ¦","ğŸ¸","ğŸ¦’","ğŸ§","ğŸ·","ğŸ°"];

        // ãƒ­ã‚°ã‚¤ãƒ³ç›£è¦–
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                my.uid = user.uid;
                my.num = user.uid.replace(/\D/g, '').substring(0, 6);
                document.getElementById('my-num').innerText = my.num;
                
                const userDoc = await getDoc(doc(db, "users", my.num));
                if (userDoc.exists()) {
                    my = { ...my, ...userDoc.data() };
                    updateMyUI();
                } else {
                    document.getElementById('edit-modal').style.display = 'flex';
                }
                syncContacts();
                initSkyWay();
            } else {
                signInWithPopup(auth, new GoogleAuthProvider());
            }
        });

        // çµµæ–‡å­—ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
        window.cycleEmoji = () => {
            let currentIdx = emojis.indexOf(document.getElementById('edit-emoji').innerText);
            let nextIdx = (currentIdx + 1) % emojis.length;
            document.getElementById('edit-emoji').innerText = emojis[nextIdx];
        };

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        window.openEdit = () => {
            document.getElementById('edit-name').value = my.name;
            document.getElementById('edit-emoji').innerText = my.emoji;
            document.getElementById('edit-modal').style.display = 'flex';
        };

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜
        window.saveProfile = async () => {
            my.name = document.getElementById('edit-name').value || "åå‰ãªã—";
            my.emoji = document.getElementById('edit-emoji').innerText;
            await setDoc(doc(db, "users", my.num), { name: my.name, emoji: my.emoji, num: my.num });
            updateMyUI();
            document.getElementById('edit-modal').style.display = 'none';
        };

        function updateMyUI() {
            document.getElementById('my-name-display').innerText = my.name;
            document.getElementById('my-avatar').innerText = my.emoji;
        }

        // ç•ªå·ã§å‹é”è¿½åŠ 
        window.addFriendByNum = async () => {
            const num = prompt("ç›¸æ‰‹ã®6æ¡ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            if (!num || num === my.num) return;
            const targetDoc = await getDoc(doc(db, "users", num));
            if (targetDoc.exists()) {
                await setDoc(doc(db, "contacts", my.num + "_" + num), { owner: my.num, target: num });
                alert(targetDoc.data().name + " ã•ã‚“ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸ");
            } else {
                alert("ãã®ç•ªå·ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
            }
        };

        // é€£çµ¡å…ˆãƒªã‚¹ãƒˆã®åŒæœŸ
        function syncContacts() {
            onSnapshot(query(collection(db, "contacts"), where("owner", "==", my.num)), async (snapshot) => {
                const list = document.getElementById('contact-list');
                list.innerHTML = "";
                for (const change of snapshot.docs) {
                    const tNum = change.data().target;
                    const uDoc = await getDoc(doc(db, "users", tNum));
                    if (uDoc.exists()) {
                        const userData = uDoc.data();
                        const div = document.createElement('div');
                        div.className = 'list-item';
                        div.innerHTML = `<div class="user-avatar">${userData.emoji}</div><div><div style="font-weight:bold;">${userData.name}</div><div style="color:#888;font-size:12px;">${userData.num}</div></div>`;
                        div.onclick = () => openChat(userData);
                        list.appendChild(div);
                    }
                }
            });
        }

        // ãƒãƒ£ãƒƒãƒˆã‚’é–‹ã
        window.openChat = (u) => {
            target = u;
            document.getElementById('chat-title').innerText = u.name;
            document.getElementById('chat-view').style.display = 'flex';
            const roomId = [my.num, u.num].sort().join("_");
            
            onSnapshot(query(collection(db, "messages"), where("room", "==", roomId), orderBy("time", "asc")), (snapshot) => {
                const chatMsgs = document.getElementById('chat-msgs');
                chatMsgs.innerHTML = "";
                snapshot.forEach(docSnap => {
                    const d = docSnap.data();
                    const div = document.createElement('div');
                    div.className = `msg ${d.sender === my.num ? 'right' : 'left'}`;
                    
                    if(d.isDeleted) {
                        div.classList.add('deleted');
                        div.innerText = "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ";
                    } else {
                        div.innerText = d.text;
                        // è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã ã‘å‰Šé™¤å¯èƒ½ã«ã™ã‚‹
                        if(d.sender === my.num) {
                            div.onclick = () => deleteMessage(docSnap.id);
                        }
                    }
                    chatMsgs.appendChild(div);
                });
                chatMsgs.scrollTop = chatMsgs.scrollHeight;
            });
        };

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ï¼ˆé€ä¿¡å–æ¶ˆï¼‰ã™ã‚‹
        window.deleteMessage = async (msgId) => {
            const confirmed = confirm("æœ¬å½“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ");
            if (confirmed) {
                try {
                    await updateDoc(doc(db, "messages", msgId), { isDeleted: true });
                } catch (e) {
                    console.error("å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ", e);
                }
            }
        };

        window.closeChat = () => {
            document.getElementById('chat-view').style.display = 'none';
        };

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
        window.send = async () => {
            const input = document.getElementById('msg-input');
            if (!input.value || !target) return;
            const roomId = [my.num, target.num].sort().join("_");
            await addDoc(collection(db, "messages"), { 
                room: roomId, 
                sender: my.num, 
                text: input.value, 
                time: serverTimestamp(), 
                isDeleted: false 
            });
            input.value = "";
        };

        // SkyWayè¨­å®šï¼ˆé€šè©±ï¼‰
        async function initSkyWay() {
            const { SkyWayContext, SkyWayRoom, SkyWayStreamFactory } = skyway_room;
            const context = await SkyWayContext.Create(SKYWAY_ID);
            const room = await SkyWayRoom.FindOrCreate(context, { type: 'p2p', name: my.num });
            const member = await room.join();

            window.call = async (type) => {
                document.getElementById('call-ui').style.display = 'flex';
                document.getElementById('call-user-name').innerText = target.name;
                document.getElementById('call-user-emoji').innerText = target.emoji;

                const tRoom = await SkyWayRoom.FindOrCreate(context, { type: 'p2p', name: target.num });
                const tMember = await tRoom.join();
                
                const audio = await SkyWayStreamFactory.createMicrophoneAudioStream();
                await tMember.publish(audio);

                if (type === 'video') {
                    const video = await SkyWayStreamFactory.createCameraVideoStream();
                    video.attach(document.getElementById('local-v'));
                    document.getElementById('local-v').style.display = 'block';
                    await tMember.publish(video);
                }

                tRoom.onStreamPublished.add(async (e) => {
                    const { stream } = await tMember.subscribe(e.publication.id);
                    if (stream.contentType === 'video') {
                        stream.attach(document.getElementById('remote-v'));
                        document.getElementById('call-user-emoji').style.display = 'none';
                    }
                });
            };

            room.onStreamPublished.add(async (e) => {
                if (e.publication.publisher.id === member.id) return;
                document.getElementById('call-ui').style.display = 'flex';
                const { stream } = await member.subscribe(e.publication.id);
                if (stream.contentType === 'video') {
                    stream.attach(document.getElementById('remote-v'));
                    document.getElementById('call-user-emoji').style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>
