<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WebCall Ultra - Full Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #00c300; --bg: #f2f4f6; --surface: #ffffff; --my-bubble: #8de055; --danger: #ff4b4b; --admin: #673ab7; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        body { background: #222; display: flex; justify-content: center; height: 100vh; overflow: hidden; }
        
        .app-container { width: 100%; max-width: 480px; height: 100%; background: var(--bg); position: relative; display: flex; flex-direction: column; }
        
        /* ãƒ­ã‚°ã‚¤ãƒ³ */
        #auth-overlay { position: absolute; inset: 0; background: var(--surface); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; text-align: center; }
        .login-btn { background: #fff; border: 1px solid #ddd; padding: 15px 30px; border-radius: 50px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header { background: #fff; padding: 15px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #eee; }
        .my-avatar { width: 45px; height: 45px; background: #eee; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 24px; border: 2px solid var(--primary); cursor: pointer; }
        .id-badge { background: var(--primary); color: white; padding: 2px 8px; border-radius: 8px; font-size: 12px; font-weight: bold; }

        /* ãƒªã‚¹ãƒˆ */
        .main-content { flex: 1; overflow-y: auto; padding: 10px; }
        .list-item { background: #fff; padding: 15px; margin-bottom: 10px; border-radius: 15px; display: flex; align-items: center; gap: 12px; cursor: pointer; position: relative; }
        .admin-tag { position: absolute; right: 10px; top: 10px; font-size: 10px; background: var(--admin); color: white; padding: 2px 5px; border-radius: 4px; }

        /* ãƒãƒ£ãƒƒãƒˆ */
        #chat-view { position: absolute; inset: 0; background: #8cabd0; z-index: 2000; display: none; flex-direction: column; }
        .chat-header { background: #fff; padding: 15px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #ddd; }
        .chat-msgs { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 80%; padding: 10px 14px; border-radius: 15px; font-size: 15px; word-break: break-all; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .msg.right { align-self: flex-end; background: var(--my-bubble); border-bottom-right-radius: 2px; }
        .msg.left { align-self: flex-start; background: #fff; border-bottom-left-radius: 2px; }
        .msg.is-deleted { opacity: 0.6; font-style: italic; }
        .admin-msg-info { display: block; font-size: 10px; color: var(--danger); font-weight: bold; margin-bottom: 2px; }

        /* é€šè©± */
        #call-ui { position: absolute; inset: 0; background: #000; z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: space-around; color: #fff; }
        video { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; }
        .call-controls { display: flex; flex-direction: column; align-items: center; gap: 20px; z-index: 10; width: 100%; }
        .hangup-btn { width: 70px; height: 70px; background: var(--danger); border-radius: 50%; border: none; color: white; font-size: 30px; cursor: pointer; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #edit-modal { position: absolute; inset: 0; background: rgba(0,0,0,0.6); z-index: 4000; display: none; align-items: center; justify-content: center; }
        .modal-card { background: #fff; width: 90%; max-height: 85vh; overflow-y: auto; padding: 25px; border-radius: 25px; text-align: center; }
        .admin-box { margin-top: 20px; padding: 15px; border: 2px dashed var(--admin); border-radius: 15px; text-align: left; display: none; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; }
    </style>
</head>
<body>

    <div class="app-container">
        <div id="auth-overlay">
            <h1 style="color:var(--primary); margin-bottom:10px;">WebCall Ultra</h1>
            <p style="color:#666; margin-bottom:30px;">é«˜æ©Ÿèƒ½ã‚¦ã‚§ãƒ–é€šè©±ã‚¢ãƒ—ãƒª</p>
            <button class="login-btn" onclick="doLogin()">Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³</button>
        </div>

        <div class="header">
            <div class="my-avatar" id="my-avatar-ui" onclick="openEdit()">ğŸ‘¤</div>
            <div style="flex:1">
                <b id="my-name-ui">èª­ã¿è¾¼ã¿ä¸­...</b><br>
                <span class="id-badge" id="my-id-ui">ID: ------</span>
            </div>
            <button onclick="addFriend()" style="background:none; border:none; font-size:26px; color:var(--primary); cursor:pointer;">â•</button>
        </div>

        <div class="main-content" id="contact-list"></div>

        <div id="chat-view">
            <div class="chat-header">
                <button onclick="closeChat()" style="border:none; background:none; font-size:22px; padding:10px;">â®</button>
                <b id="chat-title">Chat</b>
                <div style="display:flex; gap:15px; margin-right:15px;">
                    <span onclick="startCall('audio')" style="font-size:24px; cursor:pointer;">ğŸ“</span>
                    <span onclick="startCall('video')" style="font-size:24px; cursor:pointer;">ğŸ¥</span>
                </div>
            </div>
            <div class="chat-msgs" id="chat-msgs"></div>
            <div style="padding:15px; background:#fff; display:flex; gap:10px; border-top:1px solid #eee;">
                <input type="text" id="msg-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." style="margin:0; border:none; background:#f0f0f0;">
                <button onclick="sendMsg()" style="border:none; background:none; color:var(--primary); font-weight:bold; font-size:16px;">é€ä¿¡</button>
            </div>
        </div>

        <div id="call-ui">
            <video id="remote-video" autoplay playsinline></video>
            <div style="text-align:center; z-index:10; text-shadow: 0 2px 10px rgba(0,0,0,0.5);">
                <div id="call-avatar-ui" style="font-size:80px; margin-bottom:10px;">ğŸ‘¤</div>
                <h2 id="call-name-ui">Partner</h2>
                <p id="call-status">æ¥ç¶šä¸­...</p>
            </div>
            <div class="call-controls">
                <button class="hangup-btn" onclick="endCall()">âœ•</button>
            </div>
        </div>

        <div id="edit-modal">
            <div class="modal-card">
                <h3>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š</h3>
                <div class="my-avatar" id="edit-emoji" onclick="cycleEmoji()" style="margin:20px auto; width:80px; height:80px; font-size:40px;">ğŸ‘¤</div>
                <input type="text" id="edit-name" placeholder="åå‰">

                <div id="admin-section" class="admin-box">
                    <b style="color:var(--admin)">ğŸ›¡ï¸ ç®¡ç†è€…å°‚ç”¨ãƒ‘ãƒãƒ«</b>
                    <p style="font-size:11px; color:#666; margin:5px 0;">è‡ªåˆ†ã®IDã‚’è‡ªç”±ã«å¤‰æ›´ã§ãã¾ã™ï¼š</p>
                    <input type="text" id="edit-id" placeholder="æ–°ã—ã„6æ¡ã®ID" maxlength="6">
                    <p style="font-size:11px; font-weight:bold; margin-top:10px;">ç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¨ãƒªã‚¹ãƒˆï¼š</p>
                    <div id="admin-user-list" style="font-size:12px; background:#f0f0f0; padding:10px; border-radius:8px; max-height:120px; overflow-y:auto; margin-top:5px;"></div>
                </div>

                <button onclick="saveProfile()" style="width:100%; padding:15px; background:var(--primary); color:#fff; border:none; border-radius:12px; font-weight:bold; margin-top:20px; font-size:16px;">è¨­å®šã‚’ä¿å­˜</button>
                <button onclick="document.getElementById('edit-modal').style.display='none'" style="background:none; border:none; color:#888; margin-top:15px;">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@skyway-sdk/room/dist/skyway_room.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, updateDoc, query, where, orderBy, onSnapshot, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // FirebaseåˆæœŸåŒ–
        const firebaseConfig = { apiKey: "AIzaSyAqypcabvYQDHzxNnjJmbDMs-vbYXLPhI8", authDomain: "webt-f0724.firebaseapp.com", projectId: "webt-f0724", storageBucket: "webt-f0724.firebasestorage.app", appId: "1:835151283262:web:a7efe3cc384fa1a61dfd6f" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const SKYWAY_ID = '697b5b5d-3f7c-4430-bd32-deb0ca2de936';
        const ADMIN_EMAIL = "mottikoyama@gmail.com";

        let my = null;
        let target = null;
        let skywayCtx = null;
        const emojis = ["ğŸ‘¤","ğŸ±","ğŸ¶","ğŸ¦Š","ğŸ»","ğŸ¼","ğŸ¦","ğŸ¤–"];

        window.doLogin = () => signInWithPopup(auth, new GoogleAuthProvider());

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('auth-overlay').style.display = 'none';
                const q = query(collection(db, "users"), where("uid", "==", user.uid));
                const snap = await getDocs(q);
                
                if (!snap.empty) {
                    my = snap.docs[0].data();
                } else {
                    const newId = Math.floor(100000 + Math.random() * 900000).toString();
                    my = { uid: user.uid, num: newId, name: user.displayName || "ãƒ¦ãƒ¼ã‚¶ãƒ¼", emoji: "ğŸ‘¤", email: user.email };
                    await setDoc(doc(db, "users", newId), my);
                }

                // ç®¡ç†è€…ãƒã‚§ãƒƒã‚¯
                if (user.email === ADMIN_EMAIL) {
                    document.getElementById('admin-section').style.display = 'block';
                    loadAdminData();
                }

                updateMainUI();
                syncContacts();
                listenForCalls();
                // SkyWay Contextã‚’äº‹å‰ã«ä½œæˆ
                skywayCtx = await skyway_room.SkyWayContext.Create(SKYWAY_ID);
            }
        });

        async function loadAdminData() {
            const allUsers = await getDocs(collection(db, "users"));
            let html = "";
            allUsers.forEach(d => {
                const u = d.data();
                html += `<div style="border-bottom:1px solid #ddd; padding:4px 0;">ID: ${u.num} | ${u.name}</div>`;
            });
            document.getElementById('admin-user-list').innerHTML = html;
        }

        function updateMainUI() {
            document.getElementById('my-name-ui').innerText = my.name;
            document.getElementById('my-id-ui').innerText = "ID: " + my.num;
            document.getElementById('my-avatar-ui').innerText = my.emoji;
        }

        window.openEdit = () => {
            document.getElementById('edit-name').value = my.name;
            document.getElementById('edit-emoji').innerText = my.emoji;
            if (auth.currentUser.email === ADMIN_EMAIL) {
                document.getElementById('edit-id').value = my.num;
            }
            document.getElementById('edit-modal').style.display = 'flex';
        };

        window.saveProfile = async () => {
            const newName = document.getElementById('edit-name').value || "åç„¡ã—";
            const newEmoji = document.getElementById('edit-emoji').innerText;
            const newId = document.getElementById('edit-id').value;

            // IDå¤‰æ›´ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰
            if (auth.currentUser.email === ADMIN_EMAIL && newId && newId !== my.num) {
                if (!/^\d{6}$/.test(newId)) return alert("IDã¯6æ¡ã®æ•°å­—ã«ã—ã¦ãã ã•ã„");
                const exist = await getDoc(doc(db, "users", newId));
                if (exist.exists()) return alert("ãã®IDã¯æ—¢ã«ä½¿ã‚ã‚Œã¦ã„ã¾ã™");

                await deleteDoc(doc(db, "users", my.num));
                my.num = newId;
            }

            my.name = newName;
            my.emoji = newEmoji;
            my.email = auth.currentUser.email;
            await setDoc(doc(db, "users", my.num), my);
            location.reload();
        };

        window.addFriend = async () => {
            const id = prompt("è¿½åŠ ã—ãŸã„ç›¸æ‰‹ã®IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            if (id && id !== my.num) {
                const d = await getDoc(doc(db, "users", id));
                if (d.exists()) {
                    await setDoc(doc(db, "contacts", `${my.num}_${id}`), { owner: my.num, target: id });
                    alert(d.data().name + " ã•ã‚“ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚");
                } else alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
            }
        };

        function syncContacts() {
            onSnapshot(query(collection(db, "contacts"), where("owner", "==", my.num)), async (s) => {
                const list = document.getElementById('contact-list');
                list.innerHTML = "";
                for (const c of s.docs) {
                    const udSnap = await getDoc(doc(db, "users", c.data().target));
                    if (udSnap.exists()) {
                        const ud = udSnap.data();
                        const div = document.createElement('div');
                        div.className = 'list-item';
                        div.innerHTML = `<div class="my-avatar">${ud.emoji}</div><div><b>${ud.name}</b><br><small>ID: ${ud.num}</small></div>`;
                        if(ud.email === ADMIN_EMAIL) div.innerHTML += `<span class="admin-tag">å…¬å¼</span>`;
                        div.onclick = () => openChat(ud);
                        list.appendChild(div);
                    }
                }
            });
        }

        window.openChat = (u) => {
            target = u;
            document.getElementById('chat-title').innerText = u.name;
            document.getElementById('chat-view').style.display = 'flex';
            const rid = [my.num, u.num].sort().join("_");
            
            onSnapshot(query(collection(db, "messages"), where("room", "==", rid), orderBy("time", "asc")), (snap) => {
                const box = document.getElementById('chat-msgs');
                box.innerHTML = "";
                snap.forEach(d => {
                    const data = d.data();
                    const el = document.createElement('div');
                    el.className = `msg ${data.sender === my.num ? 'right' : 'left'}`;
                    
                    if (data.isDeleted) {
                        if (auth.currentUser.email === ADMIN_EMAIL) {
                            el.innerHTML = `<span class="admin-msg-info">âš  å‰Šé™¤ã•ã‚ŒãŸå†…å®¹(ç®¡ç†è€…é–²è¦§ä¸­):</span>${data.text}`;
                            el.classList.add('is-deleted');
                        } else {
                            el.innerText = "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸ";
                            el.classList.add('is-deleted');
                        }
                    } else {
                        el.innerText = data.text;
                        // è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã‚‰é•·æŠ¼ã—/ã‚¯ãƒªãƒƒã‚¯ã§å‰Šé™¤å¯èƒ½ã«ã™ã‚‹
                        if (data.sender === my.num) {
                            el.onclick = () => { if(confirm("æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) updateDoc(doc(db, "messages", d.id), {isDeleted: true}); };
                        }
                    }
                    box.appendChild(el);
                });
                box.scrollTop = box.scrollHeight;
            });
        };

        window.sendMsg = async () => {
            const i = document.getElementById('msg-input');
            if (!i.value) return;
            const rid = [my.num, target.num].sort().join("_");
            await addDoc(collection(db, "messages"), { 
                room: rid, sender: my.num, text: i.value, time: serverTimestamp(), isDeleted: false 
            });
            i.value = "";
        };

        window.startCall = async (mode) => {
            document.getElementById('call-ui').style.display = 'flex';
            document.getElementById('call-name-ui').innerText = target.name;
            document.getElementById('call-avatar-ui').innerText = target.emoji;
            document.getElementById('call-status').innerText = "å‘¼ã³å‡ºã—ä¸­...";

            await setDoc(doc(db, "calls", target.num), { 
                from: my.num, fromName: my.name, fromEmoji: my.emoji, type: mode, ts: Date.now() 
            });
            setupSkyWay(target.num, mode);
        };

        function listenForCalls() {
            onSnapshot(doc(db, "calls", my.num), async (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    if (Date.now() - data.ts < 30000) { // 30ç§’ä»¥å†…ã®ç€ä¿¡ã®ã¿
                        if (confirm(`${data.fromName} ã•ã‚“ã‹ã‚‰${data.type==='video'?'ãƒ“ãƒ‡ã‚ª':''}é€šè©±ã€‚å‡ºã¾ã™ã‹ï¼Ÿ`)) {
                            document.getElementById('call-ui').style.display = 'flex';
                            document.getElementById('call-name-ui').innerText = data.fromName;
                            document.getElementById('call-avatar-ui').innerText = data.fromEmoji;
                            setupSkyWay(my.num, data.type);
                        }
                    }
                    await deleteDoc(doc(db, "calls", my.num));
                }
            });
        }

        async function setupSkyWay(roomName, mode) {
            const { SkyWayRoom, SkyWayStreamFactory } = skyway_room;
            const room = await SkyWayRoom.FindOrCreate(skywayCtx, { type: 'p2p', name: roomName });
            const member = await room.join();

            const audio = await SkyWayStreamFactory.createMicrophoneAudioStream();
            await member.publish(audio);

            if (mode === 'video') {
                const video = await SkyWayStreamFactory.createCameraVideoStream();
                await member.publish(video);
            }

            room.onStreamPublished.add(async (e) => {
                const { stream } = await member.subscribe(e.publication.id);
                if (stream.contentType === 'video') {
                    stream.attach(document.getElementById('remote-video'));
                }
                document.getElementById('call-status').innerText = "é€šè©±ä¸­";
            });
        }

        window.endCall = () => location.reload();
        window.closeChat = () => document.getElementById('chat-view').style.display = 'none';
        window.cycleEmoji = () => {
            const el = document.getElementById('edit-emoji');
            el.innerText = emojis[(emojis.indexOf(el.innerText)+1)%emojis.length];
        };
    </script>
</body>
</html>
