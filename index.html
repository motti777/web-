<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WebCall Ultra</title>
    <script src="https://cdn.jsdelivr.net/npm/@skyway-sdk/room/dist/skyway_room.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #00c300; --bg: #f2f4f6; --surface: #ffffff; --my-bubble: #8de055; --danger: #ff4b4b; --admin: #673ab7; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        body { background: #222; display: flex; justify-content: center; height: 100vh; overflow: hidden; }
        .app-container { width: 100%; max-width: 480px; height: 100%; background: var(--bg); position: relative; display: flex; flex-direction: column; }
        
        /* ãƒ­ã‚°ã‚¤ãƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #auth-overlay { position: absolute; inset: 0; background: var(--surface); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; text-align: center; }
        .login-btn { background: #fff; border: 1px solid #ddd; padding: 15px 30px; border-radius: 50px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header { background: #fff; padding: 15px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #eee; }
        .my-avatar { width: 45px; height: 45px; background: #eee; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 24px; border: 2px solid var(--primary); cursor: pointer; }
        .id-badge { background: var(--primary); color: white; padding: 2px 8px; border-radius: 8px; font-size: 12px; font-weight: bold; }

        /* ãƒªã‚¹ãƒˆ */
        .main-content { flex: 1; overflow-y: auto; padding: 10px; }
        .list-item { background: #fff; padding: 15px; margin-bottom: 10px; border-radius: 15px; display: flex; align-items: center; gap: 12px; cursor: pointer; }

        /* ãƒãƒ£ãƒƒãƒˆç”»é¢ */
        #chat-view { position: absolute; inset: 0; background: #8cabd0; z-index: 2000; display: none; flex-direction: column; }
        .chat-header { background: #fff; padding: 15px; display: flex; align-items: center; justify-content: space-between; }
        .chat-msgs { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 80%; padding: 10px 14px; border-radius: 15px; font-size: 15px; word-break: break-all; }
        .msg.right { align-self: flex-end; background: var(--my-bubble); }
        .msg.left { align-self: flex-start; background: #fff; }
        
        /* é€šè©±ç”»é¢ */
        #call-ui { position: absolute; inset: 0; background: #000; z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: space-around; color: #fff; }
        video { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; }

        /* è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */
        #edit-modal { position: absolute; inset: 0; background: rgba(0,0,0,0.5); z-index: 4000; display: none; align-items: center; justify-content: center; }
        .modal-card { background: #fff; width: 90%; padding: 25px; border-radius: 20px; text-align: center; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; }
        .admin-area { display: none; border: 2px dashed var(--admin); padding: 10px; margin-top: 10px; text-align: left; }
        .logout-btn { color: var(--danger); margin-top: 20px; cursor: pointer; font-weight: bold; display: block; }
    </style>
</head>
<body>

    <div class="app-container">
        <div id="auth-overlay">
            <h1>WebCall Ultra</h1>
            <p>ç®¡ç†è€…: mottikoyama</p>
            <button class="login-btn" onclick="doLogin()">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
        </div>

        <div class="header">
            <div class="my-avatar" id="my-avatar-ui" onclick="openEdit()">ğŸ‘¤</div>
            <div style="flex:1">
                <b id="my-name-ui">èª­ã¿è¾¼ã¿ä¸­...</b><br>
                <span class="id-badge" id="my-id-ui">ID: ------</span>
            </div>
            <button onclick="addFriend()" style="background:none; border:none; font-size:24px; color:var(--primary);">â•</button>
        </div>

        <div class="main-content" id="contact-list"></div>

        <div id="chat-view">
            <div class="chat-header">
                <button onclick="closeChat()" style="border:none; background:none; font-size:20px;">â®</button>
                <b id="chat-title">Chat</b>
                <div style="display:flex; gap:15px;">
                    <span onclick="startCall('audio')" style="cursor:pointer;">ğŸ“</span>
                    <span onclick="startCall('video')" style="cursor:pointer;">ğŸ¥</span>
                </div>
            </div>
            <div class="chat-msgs" id="chat-msgs"></div>
            <div style="padding:10px; background:#fff; display:flex; gap:10px;">
                <input type="text" id="msg-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸..." onkeydown="if(event.key==='Enter')sendMsg()">
                <button onclick="sendMsg()" style="border:none; background:none; color:var(--primary); font-weight:bold;">é€ä¿¡</button>
            </div>
        </div>

        <div id="call-ui">
            <video id="remote-video" autoplay playsinline></video>
            <div style="text-align:center; z-index:10;"><h2 id="call-name">Partner</h2><p id="call-status">æ¥ç¶šä¸­...</p></div>
            <button onclick="location.reload()" style="padding:15px 30px; background:var(--danger); color:#fff; border:none; border-radius:30px; z-index:10;">çµ‚äº†</button>
        </div>

        <div id="edit-modal">
            <div class="modal-card">
                <h3>è¨­å®š</h3>
                <div class="my-avatar" id="edit-emoji" onclick="cycleEmoji()" style="margin:10px auto; width:60px; height:60px; font-size:30px;">ğŸ‘¤</div>
                <input type="text" id="edit-name" placeholder="åå‰">
                <div id="admin-box" class="admin-area">
                    <b style="color:var(--admin)">ç®¡ç†è€…è¨­å®š</b>
                    <input type="text" id="edit-id" placeholder="æ–°ã—ã„ID(6æ¡)" maxlength="6">
                    <div id="all-users" style="font-size:10px; max-height:80px; overflow:auto;"></div>
                </div>
                <button onclick="saveProfile()" style="width:100%; padding:15px; background:var(--primary); color:#fff; border:none; border-radius:10px; font-weight:bold; margin-top:10px;">ä¿å­˜</button>
                <span class="logout-btn" onclick="doLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</span>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, updateDoc, query, where, orderBy, onSnapshot, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAqypcabvYQDHzxNnjJmbDMs-vbYXLPhI8", authDomain: "webt-f0724.firebaseapp.com", projectId: "webt-f0724", storageBucket: "webt-f0724.firebasestorage.app", appId: "1:835151283262:web:a7efe3cc384fa1a61dfd6f" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const SKYWAY_ID = '697b5b5d-3f7c-4430-bd32-deb0ca2de936';
        const ADMIN_EMAIL = "mottikoyama@gmail.com";

        let my = null, target = null, context = null;

        window.doLogin = () => signInWithPopup(auth, new GoogleAuthProvider());
        
        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆé–¢æ•°
        window.doLogout = () => {
            if(confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
                signOut(auth).then(() => location.reload());
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('auth-overlay').style.display = 'none';
                const q = query(collection(db, "users"), where("uid", "==", user.uid));
                const snap = await getDocs(q);
                if (!snap.empty) {
                    my = snap.docs[0].data();
                } else {
                    const newId = Math.floor(100000 + Math.random() * 900000).toString();
                    my = { uid: user.uid, num: newId, name: user.displayName || "GUEST", emoji: "ğŸ‘¤" };
                    await setDoc(doc(db, "users", newId), my);
                }

                if (user.email === ADMIN_EMAIL) {
                    document.getElementById('admin-box').style.display = 'block';
                    loadUsers();
                }
                updateUI();
                listenForCalls();
                syncContacts();
                if (window.skyway_room) context = await skyway_room.SkyWayContext.Create(SKYWAY_ID);
            } else {
                document.getElementById('auth-overlay').style.display = 'flex';
            }
        });

        async function loadUsers() {
            const s = await getDocs(collection(db, "users"));
            let h = ""; s.forEach(d => h += `<div>${d.data().num}: ${d.data().name}</div>`);
            document.getElementById('all-users').innerHTML = h;
        }

        function updateUI() {
            document.getElementById('my-name-ui').innerText = my.name;
            document.getElementById('my-id-ui').innerText = "ID: " + my.num;
            document.getElementById('my-avatar-ui').innerText = my.emoji;
        }

        window.saveProfile = async () => {
            const newId = document.getElementById('edit-id').value;
            if (auth.currentUser.email === ADMIN_EMAIL && newId && newId !== my.num) {
                await deleteDoc(doc(db, "users", my.num));
                my.num = newId;
            }
            my.name = document.getElementById('edit-name').value;
            my.emoji = document.getElementById('edit-emoji').innerText;
            await setDoc(doc(db, "users", my.num), my);
            location.reload();
        };

        window.sendMsg = async () => {
            const input = document.getElementById('msg-input');
            if (!input.value || !target) return;
            const rid = [my.num, target.num].sort().join("_");
            try {
                await addDoc(collection(db, "messages"), {
                    room: rid, sender: my.num, text: input.value, time: serverTimestamp()
                });
                input.value = "";
            } catch (e) { alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼ã€‚AdGuardã‚’ç¢ºèªã—ã¦ãã ã•ã„"); }
        };

        window.startCall = async (mode) => {
            document.getElementById('call-ui').style.display = 'flex';
            document.getElementById('call-name').innerText = target.name;
            await setDoc(doc(db, "calls", target.num), { from: my.num, name: my.name, type: mode, ts: Date.now() });
            initCall(target.num, mode);
        };

        function listenForCalls() {
            onSnapshot(doc(db, "calls", my.num), async (s) => {
                if (s.exists() && Date.now() - s.data().ts < 30000) {
                    if (confirm(s.data().name + "ã‹ã‚‰ç€ä¿¡ã€‚å‡ºã¾ã™ã‹ï¼Ÿ")) {
                        document.getElementById('call-ui').style.display = 'flex';
                        initCall(my.num, s.data().type);
                    }
                    await deleteDoc(doc(db, "calls", my.num));
                }
            });
        }

        async function initCall(rName, mode) {
            const room = await skyway_room.SkyWayRoom.FindOrCreate(context, { type: 'p2p', name: rName });
            const me = await room.join();
            const audio = await skyway_room.SkyWayStreamFactory.createMicrophoneAudioStream();
            await me.publish(audio);
            if (mode === 'video') {
                const video = await skyway_room.SkyWayStreamFactory.createCameraVideoStream();
                await me.publish(video);
            }
            room.onStreamPublished.add(async (e) => {
                const { stream } = await me.subscribe(e.publication.id);
                if (stream.contentType === 'video') stream.attach(document.getElementById('remote-video'));
                document.getElementById('call-status').innerText = "é€šè©±ä¸­";
            });
        }

        window.openEdit = () => {
            document.getElementById('edit-name').value = my.name;
            document.getElementById('edit-emoji').innerText = my.emoji;
            document.getElementById('edit-modal').style.display = 'flex';
        };

        window.addFriend = async () => {
            const id = prompt("ç›¸æ‰‹ã®IDå…¥åŠ›");
            if(id) await setDoc(doc(db, "contacts", `${my.num}_${id}`), { owner: my.num, target: id });
        };

        function syncContacts() {
            onSnapshot(query(collection(db, "contacts"), where("owner", "==", my.num)), async (s) => {
                const list = document.getElementById('contact-list'); list.innerHTML = "";
                for (const c of s.docs) {
                    const ud = (await getDoc(doc(db, "users", c.data().target))).data();
                    if(ud) {
                        const d = document.createElement('div'); d.className = 'list-item';
                        d.innerHTML = `<div>${ud.emoji}</div><div><b>${ud.name}</b><br><small>${ud.num}</small></div>`;
                        d.onclick = () => {
                            target = ud;
                            document.getElementById('chat-view').style.display = 'flex';
                            document.getElementById('chat-title').innerText = ud.name;
                            const rid = [my.num, ud.num].sort().join("_");
                            onSnapshot(query(collection(db, "messages"), where("room", "==", rid), orderBy("time", "asc")), (ms) => {
                                const box = document.getElementById('chat-msgs'); box.innerHTML = "";
                                ms.forEach(m => {
                                    const el = document.createElement('div');
                                    el.className = `msg ${m.data().sender === my.num ? 'right' : 'left'}`;
                                    el.innerText = m.data().text;
                                    box.appendChild(el);
                                });
                                box.scrollTop = box.scrollHeight;
                            });
                        };
                        list.appendChild(d);
                    }
                }
            });
        }

        window.closeChat = () => document.getElementById('chat-view').style.display = 'none';
        window.cycleEmoji = () => {
            const el = document.getElementById('edit-emoji');
            const ems = ["ğŸ‘¤","ğŸ±","ğŸ¶","ğŸ¦Š","ğŸ»"];
            el.innerText = ems[(ems.indexOf(el.innerText)+1)%ems.length];
        };
    </script>
</body>
</html>
