<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LineCall Pro</title>
    <style>
        :root { --line-green: #06c755; --line-blue: #8cabd0; --my-msg: #85e249; --bg: #fff; --text: #000; --gray: #f0f0f0; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, sans-serif; }
        body { background: #000; margin: 0; display: flex; justify-content: center; height: 100vh; overflow: hidden; }
        
        .app-container { width: 100%; max-width: 450px; height: 100dvh; background: var(--bg); position: relative; display: flex; flex-direction: column; }

        /* åˆæœŸè¨­å®šç”»é¢ */
        #profile-setup { position: absolute; inset: 0; background: #fff; z-index: 4000; display: flex; flex-direction: column; align-items: center; padding: 60px 30px; }
        .setup-avatar { font-size: 80px; width: 150px; height: 150px; background: var(--gray); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 30px; cursor: pointer; border: 4px solid var(--line-green); }
        .setup-input { width: 100%; padding: 15px; border-radius: 10px; border: 1px solid #ddd; font-size: 18px; text-align: center; margin-bottom: 20px; }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ï¼šè‡ªåˆ†ã®ç•ªå· */
        .my-status-bar { background: #fff; padding: 10px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .my-num-badge { background: var(--line-green); color: #fff; padding: 4px 12px; border-radius: 20px; font-size: 14px; font-weight: bold; }

        /* é€£çµ¡å…ˆãƒªã‚¹ãƒˆ */
        .contact-list { flex: 1; overflow-y: auto; padding: 10px 0; }
        .contact-item { display: flex; align-items: center; padding: 12px 20px; cursor: pointer; border-bottom: 1px solid #f9f9f9; }
        .contact-item:active { background: #f5f5f5; }
        .contact-avatar { font-size: 30px; width: 50px; height: 50px; background: #eee; border-radius: 18px; display: flex; align-items: center; justify-content: center; margin-right: 15px; }
        .contact-info { flex: 1; }
        .contact-name { font-weight: bold; font-size: 16px; }

        /* ãƒãƒ£ãƒƒãƒˆç”»é¢ (ãƒ¢ãƒ¼ãƒ€ãƒ«) */
        #chat-view { position: absolute; inset: 0; background: var(--line-blue); z-index: 2000; display: none; flex-direction: column; }
        .chat-header { background: rgba(0,0,0,0.05); padding: 10px 15px; display: flex; align-items: center; gap: 10px; }
        .chat-title { flex: 1; font-weight: bold; text-align: center; }
        .chat-main { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        
        /* å¹ãå‡ºã— */
        .msg { max-width: 75%; padding: 8px 12px; border-radius: 15px; font-size: 15px; position: relative; }
        .msg.left { align-self: flex-start; background: #fff; }
        .msg.right { align-self: flex-end; background: var(--my-msg); }
        
        .chat-input-area { background: #fff; padding: 10px; display: flex; gap: 10px; align-items: center; }
        .chat-input { flex: 1; border: none; background: #f0f0f0; padding: 10px 15px; border-radius: 20px; outline: none; }

        /* é€šè©±ãƒœã‚¿ãƒ³ */
        .call-btn-group { display: flex; gap: 15px; }
        .icon-btn { font-size: 20px; cursor: pointer; }

        /* é€šè©±ä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #call-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; color: #fff; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; position: absolute; }
        #local-video { position: absolute; top: 20px; right: 20px; width: 100px; height: 150px; border-radius: 10px; border: 1px solid #555; display: none; }
        .call-ui-content { position: relative; z-index: 5001; text-align: center; }
        .hangup-btn { background: #ff3b30; width: 70px; height: 70px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; margin-top: 50px; border: none; color: #fff; }
    </style>
</head>
<body>

    <div class="app-container">
        <div id="profile-setup">
            <h2>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š</h2>
            <div class="setup-avatar" id="current-emoji" onclick="changeEmoji()">ğŸ‘¤</div>
            <input type="text" id="user-name-input" class="setup-input" placeholder="åå‰ã‚’å…¥åŠ›">
            <button onclick="saveProfile()" class="setup-input" style="background:var(--line-green); color:#fff; border:none; font-weight:bold;">ã¯ã˜ã‚ã‚‹</button>
        </div>

        <div class="my-status-bar">
            <div style="font-size: 12px; color: #888;">ãƒã‚¤ç•ªå·: <span id="my-num-display" class="my-num-badge">------</span></div>
            <button onclick="showAddContact()" style="background:none; border:none; font-size:20px;">ğŸ‘¤ï¼‹</button>
        </div>
        
        <div class="contact-list" id="contact-list">
            </div>

        <div id="chat-view">
            <div class="chat-header">
                <span onclick="closeChat()" class="icon-btn">â—€</span>
                <div class="chat-title" id="chat-with-name">åå‰</div>
                <div class="call-btn-group">
                    <span onclick="startCall('audio')" class="icon-btn">ğŸ“</span>
                    <span onclick="startCall('video')" class="icon-btn">ğŸ¥</span>
                </div>
            </div>
            <div class="chat-main" id="chat-msgs"></div>
            <div class="chat-input-area">
                <input type="text" id="chat-input-text" class="chat-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›">
                <button onclick="sendMsg()" style="background:none; border:none; color:var(--line-green); font-weight:bold;">é€ä¿¡</button>
            </div>
        </div>

        <div id="call-overlay">
            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" autoplay playsinline muted></video>
            <div class="call-ui-content" id="call-info">
                <div class="setup-avatar" style="border:none;" id="call-avatar">ğŸ‘¤</div>
                <h2 id="call-name">åå‰</h2>
                <p id="call-status">é€šè©±ä¸­...</p>
                <div style="display:flex; gap:20px; justify-content:center;">
                    <button id="v-toggle" onclick="toggleVideo()" style="padding:10px; border-radius:10px; border:none;">ğŸ¥ ON/OFF</button>
                </div>
                <button onclick="location.reload()" class="hangup-btn">âœ•</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@skyway-sdk/room/dist/skyway_room.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAqypcabvYQDHzxNnjJmbDMs-vbYXLPhI8", authDomain: "webt-f0724.firebaseapp.com", projectId: "webt-f0724", storageBucket: "webt-f0724.firebasestorage.app", appId: "1:835151283262:web:a7efe3cc384fa1a61dfd6f" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const SKYWAY_ID = '697b5b5d-3f7c-4430-bd32-deb0ca2de936';

        let myProfile = { name: "", emoji: "ğŸ‘¤", num: "" };
        let selectedContact = null;

        // ã‚¨ãƒ¢ã‚¸å¤‰æ›´
        const emojis = ["ğŸ‘¤","ğŸ±","ğŸ¶","ğŸ¦Š","ğŸ»","ğŸ¼","ğŸ¦","ğŸ¸"];
        window.changeEmoji = () => {
            const current = emojis.indexOf(currentEmoji.innerText);
            currentEmoji.innerText = emojis[(current + 1) % emojis.length];
        };

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜
        window.saveProfile = () => {
            if(!userNameInput.value) return alert("åå‰ã‚’å…¥ã‚Œã¦ã­");
            myProfile.name = userNameInput.value;
            myProfile.emoji = currentEmoji.innerText;
            profileSetup.style.display = 'none';
            doGoogleLogin();
        };

        window.doGoogleLogin = () => signInWithPopup(auth, new GoogleAuthProvider());

        onAuthStateChanged(auth, (user) => {
            if (user) {
                myProfile.num = user.uid.replace(/\D/g, '').substring(0, 6);
                myNumDisplay.innerText = myProfile.num;
                profileSetup.style.display = 'none';
                syncContacts();
                initSkyWay();
            }
        });

        // é€£çµ¡å…ˆè¿½åŠ 
        window.showAddContact = () => {
            const n = prompt("åå‰ã‚’å…¥åŠ›");
            const num = prompt("6æ¡ã®ç•ªå·ã‚’å…¥åŠ›");
            if(n && num) addDoc(collection(db, "contacts"), { uid: auth.currentUser.uid, name: n, num: num, emoji: emojis[Math.floor(Math.random()*emojis.length)] });
        };

        function syncContacts() {
            onSnapshot(query(collection(db, "contacts"), where("uid", "==", auth.currentUser.uid)), s => {
                contactList.innerHTML = "";
                s.forEach(doc => {
                    const d = doc.data();
                    const div = document.createElement('div');
                    div.className = 'contact-item';
                    div.innerHTML = `<div class="contact-avatar">${d.emoji || 'ğŸ‘¤'}</div><div class="contact-info"><div class="contact-name">${d.name}</div></div>`;
                    div.onclick = () => openChat(d);
                    contactList.appendChild(div);
                });
            });
        }

        // ãƒãƒ£ãƒƒãƒˆ
        window.openChat = (contact) => {
            selectedContact = contact;
            chatWithName.innerText = contact.name;
            chatView.style.display = 'flex';
            const q = query(collection(db, "msgs"), where("pair", "in", [myProfile.num+contact.num, contact.num+myProfile.num]), orderBy("time", "asc"));
            onSnapshot(q, s => {
                chatMsgs.innerHTML = "";
                s.forEach(m => {
                    const data = m.data();
                    const div = document.createElement('div');
                    div.className = `msg ${data.from === myProfile.num ? 'right' : 'left'}`;
                    div.innerText = data.text;
                    chatMsgs.appendChild(div);
                });
                chatMsgs.scrollTop = chatMsgs.scrollHeight;
            });
        };

        window.closeChat = () => chatView.style.display = 'none';

        window.sendMsg = () => {
            if(!chatInputText.value) return;
            addDoc(collection(db, "msgs"), { pair: myProfile.num + selectedContact.num, from: myProfile.num, text: chatInputText.value, time: serverTimestamp() });
            chatInputText.value = "";
        };

        // é€šè©±é–¢é€£
        let startCallFunc, toggleVideoFunc;
        async function initSkyWay() {
            const { SkyWayContext, SkyWayRoom, SkyWayStreamFactory } = skyway_room;
            const context = await SkyWayContext.Create(SKYWAY_ID);
            const room = await SkyWayRoom.FindOrCreate(context, { type: 'p2p', name: myProfile.num });
            const member = await room.join();

            let localVideoTrack, videoPub;

            window.startCall = async (type) => {
                callOverlay.style.display = 'flex';
                callName.innerText = selectedContact.name;
                callAvatar.innerText = selectedContact.emoji;

                const tRoom = await SkyWayRoom.FindOrCreate(context, { type: 'p2p', name: selectedContact.num });
                const tMember = await tRoom.join();
                const audio = await SkyWayStreamFactory.createMicrophoneAudioStream();
                await tMember.publish(audio);

                tRoom.onStreamPublished.add(async (e) => {
                    const { stream } = await tMember.subscribe(e.publication.id);
                    if (stream.contentType === 'video') {
                        stream.attach(remoteVideo);
                        callInfo.style.opacity = "0.2";
                    }
                });
            };

            window.toggleVideo = async () => {
                if(!localVideoTrack) {
                    localVideoTrack = await SkyWayStreamFactory.createCameraVideoStream();
                    localVideoTrack.attach(localVideo);
                    localVideo.style.display = 'block';
                    videoPub = await member.publish(localVideoTrack);
                } else {
                    await videoPub.unpublish();
                    localVideoTrack.release();
                    localVideoTrack = null;
                    localVideo.style.display = 'none';
                }
            };

            room.onStreamPublished.add(async (e) => {
                if (e.publication.publisher.id === member.id) return;
                callOverlay.style.display = 'flex';
                const { stream } = await member.subscribe(e.publication.id);
                if (stream.contentType === 'video') {
                    stream.attach(remoteVideo);
                    callInfo.style.opacity = "0.2";
                }
            });
        }

        const profileSetup = document.getElementById('profile-setup');
        const currentEmoji = document.getElementById('current-emoji');
        const userNameInput = document.getElementById('user-name-input');
        const myNumDisplay = document.getElementById('my-num-display');
        const contactList = document.getElementById('contact-list');
        const chatView = document.getElementById('chat-view');
        const chatMsgs = document.getElementById('chat-msgs');
        const chatInputText = document.getElementById('chat-input-text');
        const chatWithName = document.getElementById('chat-with-name');
        const callOverlay = document.getElementById('call-overlay');
        const callName = document.getElementById('call-name');
        const callAvatar = document.getElementById('call-avatar');
        const remoteVideo = document.getElementById('remote-video');
        const localVideo = document.getElementById('local-video');
        const callInfo = document.getElementById('call-info');
    </script>
</body>
</html>
