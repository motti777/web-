<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LineCall Pro</title>
    <style>
        :root { --line-green: #06c755; --line-blue: #8cabd0; --my-msg: #85e249; --bg: #fff; --text: #000; --gray: #f0f0f0; --danger: #ff3b30; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, "Helvetica Neue", sans-serif; }
        body { background: #000; margin: 0; display: flex; justify-content: center; height: 100vh; overflow: hidden; }
        
        .app-container { width: 100%; max-width: 450px; height: 100dvh; background: var(--bg); position: relative; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.5); }

        /* „Éó„É≠„Éï„Ç£„Éº„É´Ë®≠ÂÆö */
        #profile-setup { position: absolute; inset: 0; background: #fff; z-index: 4000; display: flex; flex-direction: column; align-items: center; padding: 60px 30px; }
        .setup-avatar { font-size: 80px; width: 140px; height: 140px; background: var(--gray); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 30px; cursor: pointer; border: 4px solid var(--line-green); }
        .setup-input { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #ddd; font-size: 18px; text-align: center; margin-bottom: 20px; outline: none; }

        /* „Éò„ÉÉ„ÉÄ„Éº */
        .header { background: #fff; padding: 10px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .my-num-display { background: var(--line-green); color: #fff; padding: 5px 15px; border-radius: 20px; font-size: 14px; font-weight: bold; }

        /* ÈÄ£Áµ°ÂÖà„É™„Çπ„Éà */
        .contact-list { flex: 1; overflow-y: auto; background: #fff; }
        .contact-item { display: flex; align-items: center; padding: 12px 20px; cursor: pointer; border-bottom: 1px solid #f5f5f5; transition: 0.2s; }
        .contact-item:active { background: #f0f0f0; }
        .c-avatar { font-size: 28px; width: 55px; height: 55px; background: #eee; border-radius: 20px; display: flex; align-items: center; justify-content: center; margin-right: 15px; }
        .c-name { font-weight: bold; font-size: 17px; }

        /* „ÉÅ„É£„ÉÉ„ÉàÁîªÈù¢ */
        #chat-view { position: absolute; inset: 0; background: var(--line-blue); z-index: 2000; display: none; flex-direction: column; }
        .chat-nav { background: rgba(255,255,255,0.9); padding: 12px 15px; display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .chat-main { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        .msg { max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 15px; line-height: 1.4; position: relative; }
        .msg.left { align-self: flex-start; background: #fff; border-top-left-radius: 2px; }
        .msg.right { align-self: flex-end; background: var(--my-msg); border-top-right-radius: 2px; }
        .chat-input-area { background: #fff; padding: 12px; display: flex; gap: 10px; align-items: center; }
        .c-input { flex: 1; border: none; background: #f0f0f0; padding: 12px 18px; border-radius: 25px; outline: none; font-size: 16px; }

        /* ÈÄöË©±ÁîªÈù¢ */
        #call-overlay { position: absolute; inset: 0; background: #000; z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; position: absolute; }
        #local-video { position: absolute; top: 30px; right: 20px; width: 110px; height: 160px; border-radius: 15px; border: 1px solid #555; display: none; object-fit: cover; z-index: 5002; }
        .call-ui { position: relative; z-index: 5001; text-align: center; color: #fff; }
        .call-ctrl { position: absolute; bottom: 60px; width: 100%; display: flex; justify-content: space-evenly; z-index: 5003; }
        .ctrl-btn { width: 70px; height: 70px; border-radius: 35px; border: none; background: rgba(255,255,255,0.2); color: white; font-size: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .hangup { background: var(--danger); width: 80px; height: 80px; }
    </style>
</head>
<body>

    <div class="app-container">
        <div id="profile-setup">
            <h2 style="margin-bottom: 10px;">„Éó„É≠„Éï„Ç£„Éº„É´Ë®≠ÂÆö</h2>
            <p style="color: #888; margin-bottom: 30px;">Ëá™ÂàÜ„ÇíË°®„Åô„Ç¢„Ç§„Ç≥„É≥„Å®ÂêçÂâç„ÇíÊ±∫„ÇÅ„Å¶„Å≠</p>
            <div class="setup-avatar" id="setup-emoji" onclick="changeEmoji()">üë§</div>
            <input type="text" id="setup-name" class="setup-input" placeholder="ÂêçÂâç„ÇíÂÖ•Âäõ">
            <button onclick="saveProfileAndLogin()" class="setup-input" style="background:var(--line-green); color:#fff; border:none; font-weight:bold; cursor:pointer;">„ÅØ„Åò„ÇÅ„Çã</button>
        </div>

        <div class="header">
            <div style="font-size: 12px; color: #888;">„Éû„Ç§Áï™Âè∑: <span id="my-num-display" class="my-num-display">------</span></div>
            <button onclick="addContactByNumber()" style="background:none; border:none; font-size:24px; cursor:pointer;">üë§Ôºã</button>
        </div>
        
        <div class="contact-list" id="contact-list"></div>

        <div id="chat-view">
            <div class="chat-nav">
                <span onclick="closeChat()" style="font-size:24px; cursor:pointer;">‚óÄ</span>
                <div style="flex:1; font-weight:bold; font-size:18px;" id="chat-title-name">ÂêçÂâç</div>
                <div style="display:flex; gap:20px;">
                    <span onclick="startCall('audio')" style="font-size:22px; cursor:pointer;">üìû</span>
                    <span onclick="startCall('video')" style="font-size:22px; cursor:pointer;">üé•</span>
                </div>
            </div>
            <div class="chat-main" id="chat-msgs"></div>
            <div class="chat-input-area">
                <input type="text" id="msg-input" class="c-input" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ...">
                <button onclick="sendMsg()" style="background:none; border:none; color:var(--line-green); font-weight:bold; font-size:16px;">ÈÄÅ‰ø°</button>
            </div>
        </div>

        <div id="call-overlay">
            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" autoplay playsinline muted></video>
            <div class="call-ui" id="call-ui-layer">
                <div id="call-avatar" style="font-size:80px; margin-bottom:20px;">üë§</div>
                <h2 id="call-target-name" style="font-size:32px; margin:0;">ÂêçÂâç</h2>
                <p id="call-status-text" style="color:var(--line-green); font-weight:bold;">ÈÄöË©±‰∏≠</p>
            </div>
            <div class="call-ctrl">
                <button onclick="toggleVideo()" class="ctrl-btn" id="video-toggle-btn">üé•</button>
                <button onclick="location.reload()" class="ctrl-btn hangup">‚úï</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@skyway-sdk/room/dist/skyway_room.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp, setDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAqypcabvYQDHzxNnjJmbDMs-vbYXLPhI8", authDomain: "webt-f0724.firebaseapp.com", projectId: "webt-f0724", storageBucket: "webt-f0724.firebasestorage.app", appId: "1:835151283262:web:a7efe3cc384fa1a61dfd6f" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const SKYWAY_ID = '697b5b5d-3f7c-4430-bd32-deb0ca2de936';

        let myData = { name: "", emoji: "üë§", num: "" };
        let activePair = null;
        const emojiList = ["üë§","üê∂","üê±","ü¶ä","üêª","üêº","üê®","üêØ","üê∏"];

        window.changeEmoji = () => {
            const idx = emojiList.indexOf(setupEmoji.innerText);
            setupEmoji.innerText = emojiList[(idx + 1) % emojiList.length];
        };

        window.saveProfileAndLogin = async () => {
            if(!setupName.value) return alert("ÂêçÂâç„ÇíÊïô„Åà„Å¶„Å≠");
            myData.name = setupName.value;
            myData.emoji = setupEmoji.innerText;
            signInWithPopup(auth, new GoogleAuthProvider());
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const myNum = user.uid.replace(/\D/g, '').substring(0, 6);
                myData.num = myNum;
                myNumDisplay.innerText = myNum;
                
                // „Çµ„Éº„Éê„Éº„Å´Ëá™ÂàÜ„ÅÆ„Éó„É≠„Éï„Ç£„Éº„É´„ÇíÁôªÈå≤
                await setDoc(doc(db, "users", myNum), { name: myData.name, emoji: myData.emoji, num: myNum }, { merge: true });
                
                profileSetup.style.display = 'none';
                syncContacts();
                initSkyWay();
            }
        });

        window.addContactByNumber = async () => {
            const targetNum = prompt("ÂèãÈÅî„ÅÆ6Ê°Å„ÅÆÁï™Âè∑„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
            if(!targetNum || targetNum === myData.num) return;
            
            // Áõ∏Êâã„ÅåÂ≠òÂú®„Åô„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            const userDoc = await getDoc(doc(db, "users", targetNum));
            if(userDoc.exists()) {
                await addDoc(collection(db, "contacts"), { owner: myData.num, targetNum: targetNum });
            } else {
                alert("„Åù„ÅÆÁï™Âè∑„ÅÆ„É¶„Éº„Ç∂„Éº„ÅØË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü");
            }
        };

        function syncContacts() {
            onSnapshot(query(collection(db, "contacts"), where("owner", "==", myData.num)), s => {
                contactList.innerHTML = "";
                s.forEach(async cDoc => {
                    const targetNum = cDoc.data().targetNum;
                    const u = await getDoc(doc(db, "users", targetNum));
                    if(u.exists()) {
                        const d = u.data();
                        const div = document.createElement('div');
                        div.className = 'contact-item';
                        div.innerHTML = `<div class="c-avatar">${d.emoji}</div><div><div class="c-name">${d.name}</div><div style="font-size:12px;color:#888;">${d.num}</div></div>`;
                        div.onclick = () => openChat(d);
                        contactList.appendChild(div);
                    }
                });
            });
        }

        window.openChat = (target) => {
            activePair = target;
            chatTitleName.innerText = target.name;
            chatView.style.display = 'flex';
            const roomID = [myData.num, target.num].sort().join("_");
            onSnapshot(query(collection(db, "messages"), where("room", "==", roomID), orderBy("time", "asc")), s => {
                chatMsgs.innerHTML = "";
                s.forEach(m => {
                    const d = m.data();
                    const div = document.createElement('div');
                    div.className = `msg ${d.from === myData.num ? 'right' : 'left'}`;
                    div.innerText = d.text;
                    chatMsgs.appendChild(div);
                });
                chatMsgs.scrollTop = chatMsgs.scrollHeight;
            });
        };

        window.closeChat = () => chatView.style.display = 'none';

        window.sendMsg = async () => {
            if(!msgInput.value || !activePair) return;
            const roomID = [myData.num, activePair.num].sort().join("_");
            await addDoc(collection(db, "messages"), { room: roomID, from: myData.num, text: msgInput.value, time: serverTimestamp() });
            msgInput.value = "";
        };

        // SkyWay / ÈÄöË©±
        let room, member, context, localVideoTrack, videoPub;
        async function initSkyWay() {
            const { SkyWayContext, SkyWayRoom, SkyWayStreamFactory } = skyway_room;
            context = await SkyWayContext.Create(SKYWAY_ID);
            room = await SkyWayRoom.FindOrCreate(context, { type: 'p2p', name: myData.num });
            member = await room.join();

            window.startCall = async (type) => {
                callOverlay.style.display = 'flex';
                callTargetName.innerText = activePair.name;
                callAvatar.innerText = activePair.emoji;
                
                const tRoom = await SkyWayRoom.FindOrCreate(context, { type: 'p2p', name: activePair.num });
                const tMember = await tRoom.join();
                const audio = await SkyWayStreamFactory.createMicrophoneAudioStream();
                await tMember.publish(audio);

                tRoom.onStreamPublished.add(async (e) => {
                    const { stream } = await tMember.subscribe(e.publication.id);
                    if (stream.contentType === 'video') {
                        stream.attach(remoteVideo);
                        callUiLayer.style.opacity = "0.2";
                    }
                });
            };

            window.toggleVideo = async () => {
                if(!localVideoTrack) {
                    localVideoTrack = await SkyWayStreamFactory.createCameraVideoStream();
                    localVideoTrack.attach(localVideo);
                    localVideo.style.display = 'block';
                    videoPub = await member.publish(localVideoTrack);
                    videoToggleBtn.style.background = "var(--line-green)";
                } else {
                    await videoPub.unpublish();
                    localVideoTrack.release();
                    localVideoTrack = null;
                    localVideo.style.display = 'none';
                    videoToggleBtn.style.background = "rgba(255,255,255,0.2)";
                }
            };

            room.onStreamPublished.add(async (e) => {
                if (e.publication.publisher.id === member.id) return;
                callOverlay.style.display = 'flex';
                const { stream } = await member.subscribe(e.publication.id);
                if (stream.contentType === 'video') {
                    stream.attach(remoteVideo);
                    callUiLayer.style.opacity = "0.2";
                }
            });
        }

        const profileSetup = document.getElementById('profile-setup');
        const setupEmoji = document.getElementById('setup-emoji');
        const setupName = document.getElementById('setup-name');
        const myNumDisplay = document.getElementById('my-num-display');
        const contactList = document.getElementById('contact-list');
        const chatView = document.getElementById('chat-view');
        const chatMsgs = document.getElementById('chat-msgs');
        const msgInput = document.getElementById('msg-input');
        const chatTitleName = document.getElementById('chat-title-name');
        const callOverlay = document.getElementById('call-overlay');
        const callTargetName = document.getElementById('call-target-name');
        const callAvatar = document.getElementById('call-avatar');
        const remoteVideo = document.getElementById('remote-video');
        const localVideo = document.getElementById('local-video');
        const callUiLayer = document.getElementById('call-ui-layer');
        const videoToggleBtn = document.getElementById('video-toggle-btn');
    </script>
</body>
</html>
