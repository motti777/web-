<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒ“ãƒ‡ã‚ªé›»è©±ã‚¢ãƒ—ãƒª</title>
    <style>
        :root { --accent: #34c759; --bg: #000; --card: #1c1c1e; --text: #fff; --danger: #ff3b30; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        
        /* ã‚¹ãƒãƒ›ãƒ»PCä¸¡å¯¾å¿œã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .app-container { width: 100%; max-width: 400px; height: 100vh; max-height: 800px; background: var(--card); border-radius: 30px; position: relative; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.7); border: 1px solid #333; }
        @media (max-width: 500px) { .app-container { border-radius: 0; height: 100dvh; max-height: none; border: none; } }

        .content { flex: 1; padding: 25px; display: flex; flex-direction: column; align-items: center; width: 100%; }
        .title { font-size: 26px; font-weight: 800; margin: 40px 0 10px; color: var(--accent); }
        
        /* è‡ªåˆ†ã®ç•ªå·ã‚’è¡¨ç¤ºã™ã‚‹ã‚«ãƒ¼ãƒ‰ */
        .number-display { background: #2c2c2e; width: 100%; padding: 20px; border-radius: 20px; text-align: center; margin: 20px 0; border: 1px solid #3a3a3c; }
        .num-value { font-size: 44px; font-weight: 800; color: #fff; letter-spacing: 4px; margin: 5px 0; }
        .status-tag { font-size: 12px; color: var(--accent); font-weight: bold; background: rgba(52, 199, 89, 0.1); padding: 4px 10px; border-radius: 10px; }

        /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
        input { width: 100%; padding: 16px; margin: 10px 0; border-radius: 15px; border: 1px solid #444; background: #2c2c2e; color: white; font-size: 18px; text-align: center; outline: none; }
        input:focus { border-color: var(--accent); }
        .btn { width: 100%; padding: 18px; border-radius: 15px; border: none; font-weight: bold; cursor: pointer; font-size: 18px; margin: 10px 0; transition: 0.2s; }
        .btn-main { background: var(--accent); color: white; border-radius: 50px; }
        .btn-sub { background: transparent; color: #0a84ff; font-size: 14px; }

        /* é€šè©±ä¸­ç”»é¢ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰ */
        #call-screen { position: absolute; inset: 0; background: #000; z-index: 1000; display: none; flex-direction: column; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { position: absolute; top: 40px; right: 20px; width: 100px; height: 150px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.4); object-fit: cover; z-index: 1001; }
        .call-footer { position: absolute; bottom: 60px; width: 100%; display: flex; flex-direction: column; align-items: center; z-index: 1002; }
        .end-call { width: 70px; height: 70px; border-radius: 50%; background: var(--danger); border: none; color: white; font-size: 30px; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div class="app-container">
        <div id="auth-ui" class="content">
            <div class="title">ãƒ“ãƒ‡ã‚ªé›»è©±</div>
            <p style="color:#aaa; font-size:14px;">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¦é–‹å§‹</p>
            <input type="email" id="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
            <input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
            <button onclick="doLogin()" class="btn btn-main" style="border-radius:15px;">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <button onclick="doSignUp()" class="btn btn-sub">æ–°ã—ãã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œã‚‹</button>
        </div>

        <div id="main-ui" class="content" style="display:none;">
            <div class="number-display">
                <span class="status-tag">â— å¾…æ©Ÿä¸­</span>
                <div class="num-value" id="my-num-display">------</div>
                <div style="font-size: 12px; color: #888;">ã‚ãªãŸã®ç•ªå·</div>
            </div>
            
            <p style="color:#888; margin-top:20px;">ç›¸æ‰‹ã®ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
            <input type="number" id="target-num-input" placeholder="6æ¡ã®ç•ªå·">
            <button id="btn-call-start" class="btn btn-main">ğŸ“ é›»è©±ã‚’ã‹ã‘ã‚‹</button>
            
            <button onclick="doLogout()" class="btn btn-sub" style="margin-top:auto; color:#888;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>

        <div id="call-screen">
            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" autoplay playsinline muted></video>
            <div class="call-footer">
                <div id="call-msg" style="margin-bottom:20px; color:#fff; text-shadow: 0 0 10px #000;">æ¥ç¶šä¸­...</div>
                <button onclick="location.reload()" class="end-call">âœ•</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@skyway-sdk/room/dist/skyway_room.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAqypcabvYQDHzxNnjJmbDMs-vbYXLPhI8",
            authDomain: "webt-f0724.firebaseapp.com",
            projectId: "webt-f0724",
            storageBucket: "webt-f0724.firebasestorage.app",
            messagingSenderId: "835151283262",
            appId: "1:835151283262:web:a7efe3cc384fa1a61dfd6f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const SKYWAY_ID = '697b5b5d-3f7c-4430-bd32-deb0ca2de936';

        // --- ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ç™»éŒ²å‡¦ç† ---
        window.doSignUp = () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            createUserWithEmailAndPassword(auth, e, p).catch(err => alert("ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚Firebaseã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"));
        };
        window.doLogin = () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            signInWithEmailAndPassword(auth, e, p).catch(err => alert("ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚"));
        };
        window.doLogout = () => signOut(auth);

        // --- çŠ¶æ…‹ã®å¤‰åŒ–ã‚’ãƒã‚§ãƒƒã‚¯ ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('auth-ui').style.display = 'none';
                document.getElementById('main-ui').style.display = 'flex';
                const myNum = user.uid.replace(/\D/g, '').substring(0, 6);
                document.getElementById('my-num-display').innerText = myNum;
                initCallSystem(myNum);
            } else {
                document.getElementById('auth-ui').style.display = 'flex';
                document.getElementById('main-ui').style.display = 'none';
            }
        });

        // --- SkyWay é€šè©±ã‚·ã‚¹ãƒ†ãƒ  ---
        async function initCallSystem(myNum) {
            const { SkyWayContext, SkyWayRoom, SkyWayStreamFactory } = skyway_room;
            const context = await SkyWayContext.Create(SKYWAY_ID);
            const room = await SkyWayRoom.FindOrCreate(context, { type: 'p2p', name: myNum });
            const member = await room.join();

            // ç€ä¿¡ï¼ˆç›¸æ‰‹ã‹ã‚‰é›»è©±ãŒæ¥ãŸï¼‰
            room.onStreamPublished.add(async (e) => {
                if (e.publication.publisher.id === member.id) return;
                document.getElementById('call-screen').style.display = 'flex';
                const { audio, video } = await SkyWayStreamFactory.createMicrophoneAudioAndCameraStream();
                video.attach(document.getElementById('local-video'));
                await member.publish(audio); await member.publish(video);
                const { stream } = await member.subscribe(e.publication.id);
                if (stream.contentType === 'video') {
                    stream.attach(document.getElementById('remote-video'));
                    document.getElementById('call-msg').innerText = "é€šè©±ä¸­";
                }
            });

            // ç™ºä¿¡ï¼ˆè‡ªåˆ†ã‹ã‚‰é›»è©±ã‚’ã‹ã‘ã‚‹ï¼‰
            document.getElementById('btn-call-start').onclick = async () => {
                const target = document.getElementById('target-num-input').value;
                if(!target) return alert("ç›¸æ‰‹ã®ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                document.getElementById('call-screen').style.display = 'flex';
                
                const tRoom = await SkyWayRoom.FindOrCreate(context, { type: 'p2p', name: target });
                const tMember = await tRoom.join();
                const { audio, video } = await SkyWayStreamFactory.createMicrophoneAudioAndCameraStream();
                video.attach(document.getElementById('local-video'));
                await tMember.publish(audio); await tMember.publish(video);

                tRoom.onStreamPublished.add(async (e) => {
                    if (e.publication.publisher.id === tMember.id) return;
                    const { stream } = await tMember.subscribe(e.publication.id);
                    if (stream.contentType === 'video') {
                        stream.attach(document.getElementById('remote-video'));
                        document.getElementById('call-msg').innerText = "æ¥ç¶šå®Œäº†";
                    }
                });
            };
        }
    </script>
</body>
</html>
