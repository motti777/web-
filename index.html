<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Phone App Pro</title>
    <style>
        :root { --accent: #34c759; --bg: #000; --card: #1c1c1e; --text: #fff; --danger: #ff3b30; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        
        /* ã‚¹ãƒãƒ›ã§ã‚‚å´©ã‚Œãªã„é­”æ³•ã®ãƒ•ãƒ¬ãƒ¼ãƒ  */
        .iphone-frame { width: 100%; max-width: 400px; height: 100vh; max-height: 850px; background: var(--card); border-radius: 40px; position: relative; border: 4px solid #333; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 50px 100px rgba(0,0,0,0.8); }
        @media (max-width: 500px) { .iphone-frame { border: none; border-radius: 0; height: 100dvh; } }

        .screen { flex: 1; padding: 25px; display: flex; flex-direction: column; align-items: center; width: 100%; }
        .logo { font-size: 28px; font-weight: 800; margin: 40px 0; background: linear-gradient(45deg, #34c759, #007aff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* è‡ªåˆ†ã®ç•ªå·ã‚«ãƒ¼ãƒ‰ */
        .my-number-card { background: #2c2c2e; width: 100%; padding: 20px; border-radius: 25px; text-align: center; margin-bottom: 25px; border: 1px solid #3a3a3c; }
        .big-number { font-size: 44px; font-weight: 800; color: var(--text); letter-spacing: 2px; margin: 8px 0; }
        .status-badge { display: inline-flex; align-items: center; font-size: 12px; color: var(--accent); background: rgba(52, 199, 89, 0.1); padding: 5px 12px; border-radius: 20px; font-weight: bold; }

        input { width: 100%; padding: 18px; margin: 8px 0; border-radius: 15px; border: none; background: #2c2c2e; color: white; font-size: 18px; text-align: center; outline: none; }
        .btn { width: 100%; padding: 18px; border-radius: 15px; border: none; font-weight: bold; cursor: pointer; font-size: 18px; margin: 8px 0; transition: 0.2s; }
        .btn-call { background: var(--accent); color: white; border-radius: 50px; }
        .btn-link { background: transparent; color: #0a84ff; font-size: 14px; }

        /* é€šè©±ç”»é¢ï¼ˆãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ï¼‰ */
        #call-ui { position: absolute; inset: 0; background: #000; z-index: 1000; display: none; flex-direction: column; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { position: absolute; top: 60px; right: 20px; width: 100px; height: 150px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.3); object-fit: cover; z-index: 1001; }
        .call-controls { position: absolute; bottom: 60px; width: 100%; display: flex; flex-direction: column; align-items: center; z-index: 1002; }
        .hangup { width: 75px; height: 75px; border-radius: 50%; background: var(--danger); border: none; color: white; font-size: 30px; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 30px rgba(255,59,48,0.5); }
    </style>
</head>
<body>

    <div class="iphone-frame">
        <div id="auth-screen" class="screen">
            <div class="logo">Phone App</div>
            <p style="color:#888; margin-bottom:20px;">ã¯ã˜ã‚ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</p>
            <input type="email" id="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
            <input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
            <button onclick="handleEmailLogin()" class="btn btn-call" style="border-radius:15px;">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <button onclick="handleEmailSignUp()" class="btn btn-link">æ–°ã—ãã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œã‚‹</button>
        </div>

        <div id="app-content" class="screen" style="display:none;">
            <div class="my-number-card">
                <span class="status-badge">â— å¾…å—ä¸­</span>
                <div class="big-number" id="my-number">------</div>
                <div style="font-size: 12px; color: #888;">ã‚ãªãŸã®é›»è©±ç•ªå·</div>
            </div>
            
            <p style="color:#888; font-size:14px;">ç›¸æ‰‹ã®ç•ªå·ã‚’å…¥åŠ›ã—ã¦ç™ºä¿¡</p>
            <input type="number" id="target-number" placeholder="6æ¡ã®ç•ªå·">
            <button id="call-start" class="btn btn-call">ğŸ“ ãƒ“ãƒ‡ã‚ªé€šè©±</button>
            
            <button onclick="handleLogout()" class="btn btn-link" style="margin-top: auto; color: #888;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>

        <div id="call-ui">
            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" autoplay playsinline muted></video>
            <div class="call-controls">
                <div id="call-status" style="margin-bottom: 20px; font-weight: 300;">å‘¼ã³å‡ºã—ä¸­...</div>
                <button onclick="location.reload()" class="hangup">âœ•</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@skyway-sdk/room/dist/skyway_room.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAqypcabvYQDHzxNnjJmbDMs-vbYXLPhI8",
            authDomain: "webt-f0724.firebaseapp.com",
            projectId: "webt-f0724",
            storageBucket: "webt-f0724.firebasestorage.app",
            messagingSenderId: "835151283262",
            appId: "1:835151283262:web:a7efe3cc384fa1a61dfd6f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const SKYWAY_ID = '697b5b5d-3f7c-4430-bd32-deb0ca2de936';

        // èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯
        window.handleEmailSignUp = () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            createUserWithEmailAndPassword(auth, e, p).then(() => alert("ç™»éŒ²å®Œäº†ï¼")).catch(err => alert("ä½œæˆã‚¨ãƒ©ãƒ¼ã€‚Firebaseã®Authè¨­å®šã‚’ç¢ºèªã—ã¦ã­"));
        };

        window.handleEmailLogin = () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            signInWithEmailAndPassword(auth, e, p).catch(err => alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—ã€‚ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ãƒ‘ã‚¹ãŒé•ã„ã¾ã™"));
        };

        window.handleLogout = () => signOut(auth);

        // çŠ¶æ…‹ç›£è¦–
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-content').style.display = 'flex';
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®æ•°å­—éƒ¨åˆ†ã ã‘ã‚’æŠœãå‡ºã—ã¦6æ¡ã®ç•ªå·ã«ã™ã‚‹
                const num = user.uid.replace(/\D/g, '').substring(0, 6) || "777888";
                document.getElementById('my-number').innerText = num;
                setupSkyWay(num);
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('app-content').style.display = 'none';
            }
        });

        // SkyWayãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ (ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¶é™ã«å¼·ã„æœ€æ–°ç‰ˆ)
        async function setupSkyWay(myNum) {
            const { SkyWayContext, SkyWayRoom, SkyWayStreamFactory } = skyway_room;
            
            // é‡è¦ï¼šãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¶é™ã®å•é¡Œã‚’é¿ã‘ã‚‹ãŸã‚ã€ãƒ†ã‚¹ãƒˆæ™‚ã¯èªè¨¼æƒ…å ±ã‚’ã‚·ãƒ³ãƒ—ãƒ«ã«
            const context = await SkyWayContext.Create(SKYWAY_ID);
            const room = await SkyWayRoom.FindOrCreate(context, { type: 'p2p', name: myNum });
            const member = await room.join();

            // èª°ã‹ã‹ã‚‰ã‹ã‹ã£ã¦ããŸæ™‚
            room.onStreamPublished.add(async (e) => {
                if (e.publication.publisher.id === member.id) return;
                document.getElementById('call-ui').style.display = 'flex';
                document.getElementById('call-status').innerText = "æ¥ç¶šä¸­...";

                const { audio, video } = await SkyWayStreamFactory.createMicrophoneAudioAndCameraStream();
                video.attach(document.getElementById('local-video'));
                await member.publish(audio); await member.publish(video);
                
                const { stream } = await member.subscribe(e.publication.id);
                if (stream.contentType === 'video') {
                    stream.attach(document.getElementById('remote-video'));
                    document.getElementById('call-status').innerText = "é€šè©±ä¸­";
                }
            });

            // è‡ªåˆ†ã‹ã‚‰ã‹ã‘ã‚‹æ™‚
            document.getElementById('call-start').onclick = async () => {
                const target = document.getElementById('target-number').value;
                if(!target) return alert("ç•ªå·ã‚’å…¥åŠ›ã—ã¦ã­");

                document.getElementById('call-ui').style.display = 'flex';
                const tRoom = await SkyWayRoom.FindOrCreate(context, { type: 'p2p', name: target });
                const tMember = await tRoom.join();

                const { audio, video } = await SkyWayStreamFactory.createMicrophoneAudioAndCameraStream();
                video.attach(document.getElementById('local-video'));
                await tMember.publish(audio); await tMember.publish(video);

                tRoom.onStreamPublished.add(async (e) => {
                    if (e.publication.publisher.id === tMember.id) return;
                    const { stream } = await tMember.subscribe(e.publication.id);
                    if (stream.contentType === 'video') {
                        stream.attach(document.getElementById('remote-video'));
                        document.getElementById('call-status').innerText = "æ¥ç¶šã•ã‚Œã¾ã—ãŸ";
                    }
                });
            };
        }
    </script>
</body>
</html>
