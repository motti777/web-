<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NextGen Phone</title>
    <style>
        :root { --accent: #34c759; --bg: #000; --card: #1c1c1e; --text: #fff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden; }
        
        .iphone-frame { width: 375px; height: 750px; background: var(--card); border-radius: 45px; position: relative; border: 8px solid #333; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 50px 100px rgba(0,0,0,0.8); }
        .screen { flex: 1; padding: 30px; display: flex; flex-direction: column; align-items: center; transition: 0.5s; }
        
        /* „Çø„Ç§„Éù„Ç∞„É©„Éï„Ç£ */
        h1 { font-size: 28px; font-weight: 700; margin-bottom: 30px; letter-spacing: -1px; }
        .number-label { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        .big-number { font-size: 42px; font-weight: 800; color: var(--accent); margin: 10px 0 30px; }

        /* ÂÖ•Âäõ„Ç®„É™„Ç¢ */
        input { width: 100%; padding: 18px; margin: 8px 0; border-radius: 15px; border: none; background: #2c2c2e; color: white; font-size: 16px; box-sizing: border-box; outline: none; transition: 0.3s; }
        input:focus { background: #3a3a3c; box-shadow: 0 0 0 2px var(--accent); }

        /* „Éú„Çø„É≥ */
        button { width: 100%; padding: 18px; margin: 10px 0; border-radius: 15px; border: none; font-weight: bold; cursor: pointer; font-size: 17px; transition: 0.2s; }
        .primary { background: var(--accent); color: white; }
        .primary:active { transform: scale(0.98); opacity: 0.9; }
        .google { background: white; color: black; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .text-link { background: transparent; color: #0a84ff; font-size: 14px; }

        /* „Éì„Éá„Ç™ÈÄöË©±„É¨„Ç§„Ç¢„Ç¶„Éà */
        #video-overlay { position: absolute; inset: 0; background: #000; z-index: 10; display: none; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { position: absolute; top: 50px; right: 20px; width: 100px; height: 150px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.3); object-fit: cover; z-index: 11; }
        .call-controls { position: absolute; bottom: 50px; width: 100%; display: flex; justify-content: center; z-index: 12; }
        .hangup { width: 70px; height: 70px; border-radius: 50%; background: #ff3b30; color: white; font-size: 30px; line-height: 0; }

        #auth-screen, #app-content { width: 100%; height: 100%; box-sizing: border-box; }
    </style>
</head>
<body>

    <div class="iphone-frame">
        <div id="auth-screen" class="screen">
            <h1>Phone App</h1>
            <input type="email" id="email" placeholder="Email Address">
            <input type="password" id="password" placeholder="Password">
            <button onclick="handleEmailLogin()" class="primary">Sign In</button>
            <button onclick="handleEmailSignUp()" class="text-link">Create Account</button>
            <div style="margin: 20px 0; color: #444;">OR</div>
            <button onclick="handleGoogleLogin()" class="google">Sign in with Google</button>
        </div>

        <div id="app-content" class="screen" style="display:none;">
            <div class="number-label">My Number</div>
            <div class="big-number" id="my-number">------</div>
            
            <input type="number" id="target-number" placeholder="Enter 6-digit number">
            <button id="call-start" class="primary" style="border-radius: 50px;">üìû Call</button>
            
            <button onclick="handleLogout()" class="text-link" style="margin-top: auto; color: #ff453a;">Log Out</button>
        </div>

        <div id="video-overlay">
            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" autoplay playsinline muted></video>
            <div class="call-controls">
                <button onclick="location.reload()" class="hangup">‚úï</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@skyway-sdk/room/dist/skyway_room.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAqypcabvYQDHzxNnjJmbDMs-vbYXLPhI8",
            authDomain: "webt-f0724.firebaseapp.com",
            projectId: "webt-f0724",
            storageBucket: "webt-f0724.firebasestorage.app",
            messagingSenderId: "835151283262",
            appId: "1:835151283262:web:a7efe3cc384fa1a61dfd6f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        const APP_ID = '697b5b5d-3f7c-4430-bd32-deb0ca2de936';
        const SECRET = 'wbcXuybOG1z0vei2ZIZmlM/TmFA7nH2KXxZHQdgFOXw=';

        // ÁùÄ‰ø°Èü≥„ÅÆÊ∫ñÂÇô
        const ringtone = new Audio('https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3');
        ringtone.loop = true;

        window.handleGoogleLogin = () => signInWithPopup(auth, provider);
        window.handleEmailSignUp = () => createUserWithEmailAndPassword(auth, email.value, password.value).catch(e => alert(e.message));
        window.handleEmailLogin = () => signInWithEmailAndPassword(auth, email.value, password.value).catch(e => alert("Login Error"));
        window.handleLogout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-content').style.display = 'flex';
                const num = user.uid.replace(/\D/g, '').substring(0, 6) || "123456";
                document.getElementById('my-number').innerText = num;
                // ÂæÖ„Å°Âèó„ÅëÈñãÂßã
                startWait(num);
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('app-content').style.display = 'none';
            }
        });

        // ÂæÖ„Å°Âèó„Åë„ÉªÈÄöË©±„É≠„Ç∏„ÉÉ„ÇØ
        async function startWait(myNum) {
            const { SkyWayContext, SkyWayRoom, SkyWayStreamFactory } = skyway_room;
            const context = await SkyWayContext.Create(APP_ID, { auth: { type: 'p2p', secretKey: SECRET } });
            const room = await SkyWayRoom.FindOrCreate(context, { type: 'p2p', name: myNum });
            
            // ÂÖ•ÂÆ§„Åå„ÅÇ„Å£„Åü„ÇâÈü≥„ÇíÈ≥¥„Çâ„Åô
            room.onMemberJoined.add(() => ringtone.play());

            document.getElementById('call-start').onclick = async () => {
                const target = document.getElementById('target-number').value;
                if(!target) return;
                
                document.getElementById('video-overlay').style.display = 'block';
                const targetRoom = await SkyWayRoom.FindOrCreate(context, { type: 'p2p', name: target });
                const member = await targetRoom.join();
                
                const { audio, video } = await SkyWayStreamFactory.createMicrophoneAudioAndCameraStream();
                video.attach(document.getElementById('local-video'));
                await member.publish(audio);
                await member.publish(video);

                targetRoom.onStreamPublished.add(async (e) => {
                    const { stream } = await member.subscribe(e.publication.id);
                    if (stream.contentType === 'video') stream.attach(document.getElementById('remote-video'));
                    ringtone.pause();
                });
            };
        }
    </script>
</body>
</html>
